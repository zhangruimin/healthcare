function realTimeDataFetcher(totalPoints){
    var stubData =[], currentData = [], buffer = [];
    var initValue = 0, isDataReady = false;
    function init(){
        while (stubData.length < totalPoints) {
            stubData.push(initValue);
        }
        refreshData();
    }

    function refreshData(){
        currentData = [];
        for(var i = 0; i < buffer.length; i++){
            currentData.push([i, buffer[i]]);
        }
        isDataReady = false;
        buffer = [0x40, 0x48, 0x50, 0x54, 0x58, 0x50, 0x48, 0x40, 0x38, 0x38, 0x38, 0x38, 0x38, 0x3c, 0x40, 0x30, 0x28, 0x20, 0x38, 0xf4, 0xf8, 0xd0, 0xa8, 0x80, 0x00, 0x08, 0x10, 0x20, 0x30, 0x34, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x40, 0x48, 0x54, 0x60, 0x68, 0x70, 0x74, 0x78, 0x70, 0x68, 0x5c, 0x50, 0x4c, 0x48, 0x44, 0x40, 0x3c, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x40, 0x38, 0x40, 0x48, 0x50, 0x54, 0x58, 0x50, 0x48, 0x40, 0x38, 0x38, 0x38, 0x38, 0x38, 0x3c, 0x40, 0x30, 0x28, 0x20, 0x38, 0xf4, 0xf8, 0xd0, 0xa8, 0x80, 0x00, 0x08, 0x10, 0x20, 0x30, 0x34, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x40, 0x48, 0x54, 0x60, 0x68, 0x70, 0x74, 0x78, 0x70, 0x68, 0x5c, 0x50, 0x4c, 0x48, 0x44, 0x40, 0x3c, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x40, 0x38, 0x40, 0x48, 0x50, 0x54, 0x58, 0x50, 0x48, 0x40, 0x38, 0x38, 0x38, 0x38, 0x38, 0x3c, 0x40, 0x30, 0x28, 0x20, 0x38, 0xf4, 0xf8, 0xd0, 0xa8, 0x80, 0x00, 0x08, 0x10, 0x20, 0x30, 0x34, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x40, 0x48, 0x54, 0x60, 0x68, 0x70, 0x74, 0x78, 0x70, 0x68, 0x5c, 0x50, 0x4c, 0x48, 0x44, 0x40, 0x3c, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x40, 0x38, 0x40, 0x48, 0x50, 0x54, 0x58, 0x50, 0x48, 0x40, 0x38, 0x38, 0x38, 0x38, 0x38, 0x3c, 0x40, 0x30, 0x28, 0x20, 0x38, 0xf4, 0xf8, 0xd0, 0xa8, 0x80, 0x00, 0x08, 0x10, 0x20, 0x30, 0x34, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x40, 0x48, 0x19]
        isDataReady = true;
        $.ajax({
            url: "/healthcare/next.do",
            type: 'Get',
            success: function (data) {
                isDataReady = true;
            },
            timeout: 30000,
            error: function () {
                alert("Failed to get data");
            }
            }
        );
    }
    init();
    return{
        getNextPacket: function(){
            if(isDataReady){
                refreshData();
                return currentData;
            } else{
                return stubData;
            }
        }
    }
}

$(function () {
    var updateInterval = 10, marginPoints = 10, totalPoints = 250;

    var options = {
        series: { shadowSize: 0 },
        yaxis: { min: 0, max: 300 },
        xaxis: { show: false }
    };


    var fetcher = realTimeDataFetcher(totalPoints);
    var currentData = fetcher.getNextPacket();

    var plot = $.plot($("#electrocardiogram"), [ currentData ], options);

    var currentX = 0;
    var newData = [];

    function refreshCurrentData(currentData, newData, currentX) {
        currentData[currentX] = newData[currentX];
        for (var j = currentX + 1 ; j < Math.min(currentX + marginPoints, currentData.length); j++) {
            currentData[j] = 0;
        }
    }

    function update() {
        if(currentX===0){
            newData = fetcher.getNextPacket();
        }

        refreshCurrentData(currentData, newData, currentX);
        plot.setData([currentData]);
        // since the axes don't change, we don't need to call plot.setupGrid()
        plot.draw();

        currentX++;
        currentX = currentX%totalPoints;
        setTimeout(update, updateInterval);
    }

    update();
});